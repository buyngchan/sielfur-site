<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getAuth,
    onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import {
    getFirestore,
    collection,
    addDoc,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import {
    getStorage,
    ref,
    uploadBytes,
    getDownloadURL
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyA7UuqPTbv22dFHz5ugxdwnz0XDTDUQiP0",
    authDomain: "jjub0812.firebaseapp.com",
    projectId: "jjub0812",
    storageBucket: "jjub0812.firebasestorage.app",
    messagingSenderId: "713500860924",
    appId: "1:713500860924:web:364e16fa1d2a1dbbef5279",
    measurementId: "G-X7MESKH6MX"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);

  const imageInput = document.getElementById("imageInput");
  const preview = document.getElementById("preview");
  const submitBtn = document.getElementById("submitBtn");
  const loginStatus = document.getElementById("loginStatus");

  let currentUser = null;
  let authReady = false;
  let selectedFile = null;

  const MAX_SIZE_MB = 10; // 허용할 최대 파일 크기 (10MB)

  // 로그인 상태 확인
  onAuthStateChanged(auth, (user) => {
    authReady = true;
    if (!user) {
      loginStatus.textContent = "로그인이 필요합니다. 로그인 페이지로 이동합니다.";
      alert("로그인이 필요합니다.");
      location.href = "login.html";
      return;
    }
    currentUser = user;
    loginStatus.textContent = `로그인 중: ${user.displayName || user.email || "사용자"}`;
    submitBtn.disabled = false;
    submitBtn.textContent = "등록하기";
  });

  // 이미지 선택 → 미리보기 + 기본 체크
  imageInput.addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (!file) return;

    // 1) 이미지 MIME 타입 체크
    if (!file.type.startsWith("image/")) {
      alert("이미지 파일만 업로드할 수 있습니다.");
      imageInput.value = "";
      selectedFile = null;
      preview.style.display = "none";
      return;
    }

    // 2) 파일 크기 체크
    const sizeMB = file.size / (1024 * 1024);
    if (sizeMB > MAX_SIZE_MB) {
      alert(`파일이 너무 큽니다. (${sizeMB.toFixed(1)}MB)\n${MAX_SIZE_MB}MB 이하의 이미지를 업로드해 주세요.`);
      imageInput.value = "";
      selectedFile = null;
      preview.style.display = "none";
      return;
    }

    selectedFile = file;
    const url = URL.createObjectURL(file);
    preview.src = url;
    preview.style.display = "block";
  });

  // 등록 버튼 클릭
  submitBtn.addEventListener("click", async () => {
    if (!authReady) {
      alert("로그인 상태를 확인하는 중입니다. 잠시 후 다시 시도해 주세요.");
      return;
    }
    if (!currentUser) {
      alert("로그인 후 이용할 수 있습니다.");
      location.href = "login.html";
      return;
    }

    const title = document.getElementById("title").value.trim();
    const price = document.getElementById("price").value.trim();
    const category = document.getElementById("category").value;
    const shortDesc = document.getElementById("shortDesc").value.trim();
    const desc = document.getElementById("desc").value.trim();
    const tagsRaw = document.getElementById("tags").value.trim();
    const slotsRaw = document.getElementById("slots").value.trim();

    if (!selectedFile) {
      alert("대표 이미지를 등록해 주세요.");
      return;
    }
    if (!title) {
      alert("제목을 입력해 주세요.");
      return;
    }
    if (!price) {
      alert("가격을 입력해 주세요.");
      return;
    }
    if (!desc) {
      alert("상세 설명을 입력해 주세요.");
      return;
    }

    submitBtn.disabled = true;
    submitBtn.textContent = "등록 중...";

    try {
      // 이미지 업로드
      const imgRef = ref(storage, `commissions/${currentUser.uid}_${Date.now()}.jpg`);
      await uploadBytes(imgRef, selectedFile);
      const imageUrl = await getDownloadURL(imgRef);

      // 태그 배열로 변환
      let tags = [];
      if (tagsRaw) {
        tags = tagsRaw.split(",").map(t => t.trim()).filter(t => t);
      }

      const maxSlots = slotsRaw ? Number(slotsRaw) : null;

      // Firestore에 문서 추가
      const docRef = await addDoc(collection(db, "commissions"), {
        uid: currentUser.uid,
        authorName: currentUser.displayName || "익명",
        title: title,
        price: Number(price),
        category: category || null,
        shortDesc: shortDesc || "",
        description: desc,
        image: imageUrl,
        tags: tags,
        maxSlots: maxSlots,
        isOpen: true,
        createdAt: serverTimestamp()
      });

      alert("커미션이 등록되었습니다!");
      location.href = `commission.html?id=${docRef.id}`;
    } catch (err) {
      console.error(err);
      alert(`등록 중 오류가 발생했습니다.\n코드: ${err.code || "알 수 없음"}\n메시지: ${err.message || err}`);
      submitBtn.disabled = false;
      submitBtn.textContent = "등록하기";
    }
  });
</script>
